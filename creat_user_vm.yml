---
- name: Create LXC containers for users in group
  hosts: "*"  # Replace with your host or host group
  vars:
    group_name: a100-01-coco-coco
  tasks:
    - name: List existing groups
      community.general.proxmox_group_info:
        api_user: "{{ var_ansible_user }}"
        api_host: "{{ var_ansible_host }}"
        api_token_id: "{{ var_ansible_token_id }}"
        api_token_secret: "{{ var_ansible_token }}"
        group: "{{ group_name }}"
      register: proxmox_groups

    - name: Set fact with users list
      set_fact:
        proxmox_groups_users: "{{ proxmox_groups.proxmox_groups | map(attribute='users') | flatten }}"

    - name: Create LXC container for each user in group
      community.general.proxmox:
        api_user: "{{ var_ansible_user }}"
        api_host: "{{ var_ansible_host }}"
        api_token_id: "{{ var_ansible_token_id }}"
        api_token_secret: "{{ var_ansible_token }}"
        vmid: "{{ item | replace('@', '-') }}"
        hostname: "{{ item }}"
        ostemplate: "local:vztmpl/ubuntu-20.04-standard_20.04-1_amd64.tar.gz"  # Replace with your desired LXC template
        cores: 1
        memory: 1024
        swap: 512
        netif: '{"net0":"name=eth0,bridge=vmbr0,ip=dhcp,tag=10,type=veth"}'
        storage: local
        disk: 8
        state: present
      with_items: "{{ proxmox_groups_users }}"
